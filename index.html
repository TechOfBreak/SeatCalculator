<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>衆議院・参議院 議席数計算ツール</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { margin-bottom: 20px; }
    .panel { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 30px; }
    label { display: block; padding: 3px 6px; border-radius: 6px; }
    label:hover { background: rgba(0,120,215,0.1); cursor: pointer; }
    button { margin-top: 10px; padding: 6px 12px; }
    .result { margin-top: 10px; font-weight: bold; }
    .charts { display: flex; gap: 40px; flex-wrap: wrap; }
    canvas { max-width: 420px; }
  </style>
</head>
<body>

<h1>衆議院・参議院 議席数計算ツール</h1>

<div class="panel">
  <h2>参議院</h2>
  <div id="sangiinContainer"></div>
  <button onclick="calcSangiin()">参議院を計算</button>
  <div id="sangiinResult" class="result"></div>
</div>

<div class="panel">
  <h2>衆議院</h2>
  <div id="shugiinContainer"></div>
  <button onclick="calcShugiin()">衆議院を計算</button>
  <div id="shugiinResult" class="result"></div>
</div>

<div class="panel">
  <h2>議席構成グラフ</h2>
  <div class="charts">
    <canvas id="sangiinChart"></canvas>
    <canvas id="shugiinChart"></canvas>
  </div>
</div>

<script>
/* ===== ライン描画プラグイン（★修正点ここ） ===== */
const thresholdLinePlugin = {
  id: "thresholdLine",
  beforeDatasetsDraw(chart, args, pluginOptions) { // ← ここが重要
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data.length) return;

    const arc = meta.data[0];
    const centerX = arc.x;
    const centerY = arc.y;
    const outerRadius = arc.outerRadius;

    const drawLine = (ratio, color, width) => {
      const startAngle = -Math.PI;
      const angle = startAngle + Math.PI * ratio;

      ctx.save();
      ctx.beginPath();
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.arc(centerX, centerY, outerRadius, angle, angle + 0.0001);
      ctx.stroke();
      ctx.restore();
    };

    drawLine(pluginOptions.majorityRatio, "#000000", 3);   // 過半数
    drawLine(pluginOptions.twoThirdsRatio, "#555555", 3); // 2/3
  }
};

Chart.register(thresholdLinePlugin);

/* ===== データ ===== */

const sangiin = {
  total: 248,
  cls: "sangiin",
  chartId: "sangiinChart",
  resultId: "sangiinResult",
  title: "参議院 議席構成",
  parties: [
    { name: "自由民主党", seats: 100, color: "#d62728" },
    { name: "立憲民主党・社民・無所属", seats: 42, color: "#9467bd" },
    { name: "国民民主党・新緑風会", seats: 25, color: "#ff7f0e" },
    { name: "公明党", seats: 21, color: "#2ca02c" },
    { name: "日本維新の会", seats: 19, color: "#1f77b4" },
    { name: "参政党", seats: 15, color: "#8c564b" },
    { name: "日本共産党", seats: 7, color: "#e41a1c" },
    { name: "れいわ新選組", seats: 6, color: "#e377c2" },
    { name: "各派に属しない議員", seats: 9, color: "#7f7f7f" },
    { name: "日本保守党", seats: 2, color: "#17becf" },
    { name: "沖縄の風", seats: 2, color: "#bcbd22" }
  ]
};

const shugiin = {
  total: 465,
  cls: "shugiin",
  chartId: "shugiinChart",
  resultId: "shugiinResult",
  title: "衆議院 議席構成",
  parties: [
    { name: "自由民主党", seats: 316, color: "#d62728" },
    { name: "中道改革連合", seats: 49, color: "#9467bd" },
    { name: "日本維新の会", seats: 36, color: "#1f77b4" },
    { name: "国民民主党", seats: 28, color: "#ff7f0e" },
    { name: "参政党", seats: 15, color: "#8c564b" },
    { name: "チームみらい", seats: 11, color: "#17becf" },
    { name: "日本共産党", seats: 4, color: "#e41a1c" },
    { name: "無所属", seats: 4, color: "#7f7f7f" },
    { name: "れいわ新選組", seats: 1, color: "#e377c2" },
    { name: "減税日本・ゆうこく連合", seats: 1, color: "#bcbd22" }
  ]
};

/* ===== UI生成 ===== */

function renderCheckboxes(containerId, house) {
  document.getElementById(containerId).innerHTML =
    house.parties.map(p =>
      `<label>
        <input type="checkbox" class="${house.cls}" data-name="${p.name}" data-seats="${p.seats}">
        ${p.name}（${p.seats}）
      </label>`
    ).join("");
}

renderCheckboxes("sangiinContainer", sangiin);
renderCheckboxes("shugiinContainer", shugiin);

/* ===== 計算 & 描画 ===== */

let charts = {};

function calcHouseResult(house) {
  const checked = [...document.querySelectorAll(`.${house.cls}:checked`)];
  const seats = checked.reduce((a,c)=>a+Number(c.dataset.seats),0);

  const majority = Math.floor(house.total / 2) + 1;
  const twoThirds = Math.ceil(house.total * 2 / 3);

  document.getElementById(house.resultId).innerHTML =
    `選択議席：${seats} / ${house.total}
     ｜${seats >= majority ? "✅ 過半数" : "❌ 過半数未満"}
     ｜${seats >= twoThirds ? "✅ 2/3" : "❌ 2/3未満"}`;

  return {
    majorityRatio: majority / house.total,
    twoThirdsRatio: twoThirds / house.total
  };
}

function buildHouseChart(house, ratios) {
  const selectedNames = new Set(
    [...document.querySelectorAll(`.${house.cls}:checked`)]
      .map(c => c.dataset.name)
  );

  const selected = house.parties.filter(p=>selectedNames.has(p.name))
                                .sort((a,b)=>b.seats-a.seats);
  const unselected = house.parties.filter(p=>!selectedNames.has(p.name))
                                  .sort((a,b)=>b.seats-a.seats)
                                  .reverse();

  const ordered = [...selected, ...unselected];

  if (charts[house.chartId]) charts[house.chartId].destroy();

  charts[house.chartId] = new Chart(
    document.getElementById(house.chartId),
    {
      type: "doughnut",
      data: {
        labels: ordered.map(p=>p.name),
        datasets: [{
          data: ordered.map(p=>p.seats),
          backgroundColor: ordered.map(p=>p.color),
          borderWidth: 1,
          borderColor: "#fff"
        }]
      },
      options: {
        rotation: -90,
        circumference: 180,
        cutout: "60%",
        plugins: {
          legend: { position: "bottom" },
          title: { display: true, text: house.title },
          thresholdLine: ratios
        }
      }
    }
  );
}

function calcSangiin() {
  buildHouseChart(sangiin, calcHouseResult(sangiin));
}

function calcShugiin() {
  buildHouseChart(shugiin, calcHouseResult(shugiin));
}

calcSangiin();
calcShugiin();
</script>

</body>
</html>